<!DOCTYPE html>
<html lang="fr" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>R(ali) Photo Normandie</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&family=Playfair+Display:wght@600;700;800&display=swap"
    rel="stylesheet" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1e3a5f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
      script-src 'self' https://unpkg.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data: blob: https://*.tile.openstreetmap.org;
      connect-src 'self' https://*.tile.openstreetmap.org;
      worker-src 'self';
      frame-src 'none';
      object-src 'none';
      base-uri 'self';
      form-action 'self'" />

  <!-- Critical CSS (above-the-fold: splash, selection, welcome, buttons) -->
  <link rel="stylesheet" href="css/critical.css" />

  <!-- Deferred CSS (game, gallery, dialogs, editor — loaded after first paint) -->
  <link rel="stylesheet" href="css/deferred.css" media="print" onload="this.media='all'" />
  <noscript><link rel="stylesheet" href="css/deferred.css" /></noscript>
</head>

<body>
  <!-- Splash screen CSS pur — visible immédiatement, masqué par App.init() -->
  <div id="splash" style="position:fixed;inset:0;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1e3a5f">
    <div class="splash-spinner"></div>
    <div style="font-family:Georgia,serif;color:#fff;font-size:1.6rem;font-weight:700;margin-top:1.2rem">R(ali) Photo</div>
    <div style="color:#fbbf24;font-size:0.85rem;margin-top:0.4rem">Chargement…</div>
  </div>

  <a class="skip-link" href="#screen-select">Aller au contenu</a>

  <!-- ===================== ECRAN DE SELECTION DU RALLY ===================== -->
  <div id="screen-select" class="screen hidden" role="main" aria-label="Selection du rally">
    <div class="select-container">
      <h1 class="select-title">Rally Photo</h1>
      <p class="select-subtitle">Choisissez votre aventure</p>
      <div class="rally-cards" id="rally-cards"></div>
      <button class="btn btn-outline btn-small select-join-btn" id="btn-join-rally">Rejoindre un rally</button>
    </div>
  </div>

  <!-- ===================== ECRAN D'ACCUEIL ===================== -->
  <div id="screen-welcome" class="screen hidden" role="main" aria-label="Ecran d'accueil">
    <div class="welcome-card">
      <h1 id="welcome-title">Rally Photo</h1>
      <p class="welcome-subtitle" id="welcome-subtitle"></p>

      <div class="welcome-rules" id="welcome-rules">
        <strong>Comment jouer :</strong><br />
        <span id="welcome-rules-text"></span>
      </div>

      <div class="input-group">
        <label for="team-name">Nom de votre equipe</label>
        <input type="text" id="team-name" placeholder="ex : Les Normands" autocomplete="off" maxlength="30" />
      </div>

      <div class="toggle-group">
        <label class="toggle-label">
          <input type="checkbox" id="free-mode-toggle" />
          <span class="toggle-slider"></span>
          <span class="toggle-text">Mode libre (toutes les etapes debloquees)</span>
        </label>
      </div>

      <div class="input-group">
        <label for="photo-quality-select">Qualite des photos</label>
        <div class="quality-options" id="photo-quality-select">
          <button class="quality-option" data-quality="low" type="button">
            <span class="quality-label">Economique</span>
            <span class="quality-desc">800px, leger</span>
          </button>
          <button class="quality-option active" data-quality="medium" type="button">
            <span class="quality-label">Standard</span>
            <span class="quality-desc">1200px, equilibre</span>
          </button>
          <button class="quality-option" data-quality="high" type="button">
            <span class="quality-label">Haute</span>
            <span class="quality-desc">1800px, detaille</span>
          </button>
        </div>
      </div>

      <button class="btn btn-primary" id="btn-start">Lancer le R(ali)</button>

      <button class="btn btn-outline btn-small" id="btn-leaderboard" style="margin-top: 0.8rem">Classement des
        equipes</button>
      <button class="btn btn-outline btn-small" id="btn-change-rally" style="margin-top: 0.5rem">Changer de
        R(ali)</button>
      <button class="btn btn-outline btn-small hidden" id="btn-install-pwa" style="margin-top: 0.5rem">Installer
        l'application</button>

      <div class="storage-indicator hidden" id="storage-indicator" role="status">
        <div class="storage-bar">
          <div class="storage-bar-fill" id="storage-bar-fill"></div>
        </div>
        <span class="storage-text" id="storage-text"></span>
      </div>
    </div>
  </div>

  <!-- ===================== ECRAN DE JEU ===================== -->
  <div id="screen-game" class="screen hidden">

    <!-- HUD -->
    <div class="hud" role="banner" aria-label="Tableau de bord">
      <span class="hud-title">R(ali) Photo</span>
      <span class="hud-team" id="hud-team"></span>
      <span class="hud-spacer"></span>
      <span class="hud-timer" id="hud-timer">00:00:00</span>
      <span class="hud-score" aria-live="polite"><span id="hud-score">0</span> pts</span>
      <span class="hud-distance" id="hud-distance" title="Distance au prochain checkpoint"></span>
      <span class="hud-eta" id="hud-eta" title="Temps restant estime"></span>
      <span class="hud-gps-accuracy" id="hud-gps-accuracy" title="Precision GPS"></span>
      <div class="hud-progress">
        <div class="hud-progress-bar">
          <div class="hud-progress-fill" id="hud-progress-fill" style="width:0%"></div>
        </div>
        <div class="hud-progress-text" id="hud-progress-text" aria-live="polite"></div>
      </div>
      <button class="hud-btn" id="btn-checkpoint-list" title="Liste des etapes"
        aria-label="Liste des etapes">&#9776;</button>
      <button class="hud-btn" id="btn-gallery" title="Galerie photo" aria-label="Galerie photo">&#128247;</button>
      <button class="hud-btn" id="btn-achievements" title="Succes" aria-label="Succes">&#127942;</button>
      <button class="hud-btn" id="btn-stats" title="Statistiques" aria-label="Statistiques">&#128202;</button>
      <button class="hud-btn" id="btn-toggle-gps" title="GPS actif" aria-label="Activer/desactiver le GPS">
        <svg id="gps-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
        </svg>
      </button>
      <button class="hud-btn" id="btn-dark-mode" title="Mode sombre"
        aria-label="Basculer le mode sombre">&#9790;</button>
    </div>

    <!-- Map -->
    <div class="map-container">
      <div id="map"></div>

      <!-- Bouton centrer sur moi -->
      <button class="map-fab" id="btn-center-user" title="Ma position" aria-label="Centrer sur ma position">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="12" cy="12" r="3" />
          <path d="M12 2v4m0 12v4m10-10h-4M6 12H2" />
        </svg>
      </button>

      <!-- Bouton telecharger la carte hors-ligne -->
      <button class="map-fab map-fab-download hidden" id="btn-download-tiles" title="Telecharger la carte hors-ligne" aria-label="Telecharger la carte pour utilisation hors-ligne">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 3v12m0 0l-4-4m4 4l4-4"/>
          <path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"/>
        </svg>
        <span class="download-progress hidden" id="download-progress"></span>
      </button>

      <!-- Checkpoint Detail Panel -->
      <div id="checkpoint-panel" class="checkpoint-panel hidden" role="dialog" aria-label="Details du checkpoint">
        <div class="cp-swipe-handle"></div>
        <div class="cp-header">
          <h2 id="cp-name"></h2>
          <button class="cp-close" id="btn-close-panel">&times;</button>
        </div>

        <span class="cp-badge" id="cp-status" aria-live="polite"></span>
        <div class="cp-points" id="cp-points"></div>
        <p class="cp-desc" id="cp-desc"></p>

        <!-- Infos pratiques structurees -->
        <div id="cp-info" class="cp-info hidden"></div>

        <div class="cp-hint" id="cp-hint"></div>

        <!-- Indices progressifs -->
        <div id="cp-hints-section" class="cp-hints hidden">
          <div id="cp-hints-list"></div>
          <button class="btn btn-outline btn-small cp-hint-btn" id="btn-use-hint">Utiliser un indice</button>
        </div>

        <!-- Defi bonus -->
        <div id="cp-bonus-section" class="cp-bonus hidden">
          <span class="cp-bonus-label">Defi bonus</span>
          <p id="cp-bonus-text"></p>
        </div>

        <!-- Photo Section (pour checkpoint actuel) -->
        <div id="cp-photo-section">
          <div class="cp-photo-actions">
            <button class="btn btn-primary btn-small" id="btn-take-photo">Prendre une photo</button>
            <button class="btn btn-secondary btn-small hidden" id="btn-validate">Valider l'etape</button>
            <button class="btn btn-outline btn-small" id="btn-navigate">Y aller</button>
          </div>
          <div id="photo-preview" class="photo-preview hidden">
            <img id="preview-img" alt="Apercu photo" />
          </div>
        </div>

        <!-- Photo terminee -->
        <div id="cp-completed-photo" class="completed-photo hidden">
          <img alt="Photo validee" />
          <div class="cp-completed-actions">
            <button class="btn btn-retake btn-small" id="btn-retake-photo">Reprendre la photo</button>
            <button class="btn btn-uncomplete btn-small" id="btn-uncomplete">Annuler la validation</button>
          </div>
        </div>

        <!-- Notes personnelles -->
        <div id="cp-notes-section" class="cp-notes hidden">
          <label for="cp-note-input" class="cp-notes-label">Notes personnelles</label>
          <textarea id="cp-note-input" class="cp-note-input" rows="2" maxlength="500" placeholder="Vos impressions, anecdotes, souvenirs..."></textarea>
          <div class="cp-note-footer">
            <span class="cp-note-count" id="cp-note-count"></span>
            <span class="cp-note-saved hidden" id="cp-note-saved" aria-live="polite">Sauvegarde</span>
          </div>
        </div>

        <!-- Bonus photo controls -->
        <div id="cp-bonus-controls" class="hidden" style="margin-top: 0.8rem">
          <div class="cp-photo-actions">
            <button class="btn btn-primary btn-small" id="btn-take-bonus">Photo bonus</button>
            <button class="btn btn-secondary btn-small hidden" id="btn-validate-bonus">Valider le bonus</button>
          </div>
          <div id="bonus-preview" class="photo-preview hidden">
            <img id="bonus-preview-img" alt="Apercu bonus" />
          </div>
        </div>

        <!-- Quiz controls -->
        <div id="cp-quiz-controls" class="hidden" style="margin-top: 0.8rem">
          <button class="btn btn-quiz btn-small" id="btn-open-quiz">&#129504; Repondre au quiz</button>
        </div>
        <div id="cp-quiz-done" class="cp-quiz-done hidden" aria-live="polite"></div>
      </div>

      <!-- Checkpoint List / Sidebar -->
      <div id="checkpoint-list" class="checkpoint-list hidden">
        <div class="cplist-header">
          <h3>Etapes du R(ali)</h3>
          <button class="cp-close" id="btn-close-cplist">&times;</button>
        </div>
        <input type="text" class="cplist-search" id="cplist-search" placeholder="Rechercher une etape..."
          autocomplete="off" />
        <ul id="cplist-items"></ul>
      </div>
    </div>

    <!-- Hidden file input for camera -->
    <input type="file" id="photo-input" accept="image/*" capture="environment" class="hidden" />

    <!-- Backup reminder banner -->
    <div id="backup-reminder" class="backup-reminder hidden" role="status" aria-live="polite">
      <span class="backup-reminder-text">Pensez a sauvegarder vos donnees !</span>
      <button class="btn btn-primary btn-small" id="btn-backup-reminder">Sauvegarder</button>
      <button class="backup-reminder-dismiss" id="btn-dismiss-backup" aria-label="Fermer">&times;</button>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
  </div>

  <!-- ===================== GALERIE PHOTO ===================== -->
  <div id="screen-gallery" class="screen hidden">
    <div class="gallery-header">
      <button class="btn btn-outline btn-small" id="btn-back-map">Retour a la carte</button>
      <h2>Galerie Photo</h2>
    </div>
    <div class="gallery-filters" id="gallery-filters">
      <button class="gallery-filter active" data-filter="all">Tout</button>
      <button class="gallery-filter" data-filter="main">Etapes</button>
      <button class="gallery-filter" data-filter="bonus">Bonus</button>
    </div>
    <div class="gallery-grid" id="gallery-grid"></div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox hidden" role="dialog" aria-label="Photo plein ecran">
      <button class="lightbox-close" id="lightbox-close" aria-label="Fermer">&times;</button>
      <button class="lightbox-nav prev" id="lightbox-prev" aria-label="Photo precedente">&#8249;</button>
      <img id="lightbox-img" alt="Photo plein ecran" />
      <button class="lightbox-nav next" id="lightbox-next" aria-label="Photo suivante">&#8250;</button>
      <div class="lightbox-info">
        <h3 id="lightbox-title"></h3>
        <p id="lightbox-date"></p>
        <p class="lightbox-note hidden" id="lightbox-note"></p>
        <button class="btn btn-outline btn-small lightbox-delete" id="lightbox-delete" aria-label="Supprimer cette photo">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- ===================== ECRAN CLASSEMENT ===================== -->
  <div id="screen-leaderboard" class="screen hidden">
    <div class="gallery-header">
      <button class="btn btn-outline btn-small" id="btn-back-map-3">Retour</button>
      <h2>Classement des equipes</h2>
    </div>
    <ul id="leaderboard-list" class="leaderboard-list" aria-live="polite"></ul>
    <div class="lb-footer">
      <button class="btn btn-outline btn-small" id="btn-export-data">Sauvegarder les donnees</button>
      <button class="btn btn-outline btn-small" id="btn-import-data">Restaurer les donnees</button>
      <input type="file" id="import-file-input" accept=".json" class="hidden" />
    </div>
  </div>

  <!-- ===================== ECRAN SUCCES ===================== -->
  <div id="screen-achievements" class="screen hidden">
    <div class="gallery-header">
      <button class="btn btn-outline btn-small" id="btn-back-from-ach">Retour</button>
      <h2>Succes</h2>
    </div>
    <div class="ach-grid" id="ach-grid"></div>
  </div>

  <!-- Achievement Toast Popup -->
  <div id="ach-popup" class="ach-popup hidden" role="status" aria-live="polite">
    <span id="ach-popup-icon" class="ach-popup-icon"></span>
    <div class="ach-popup-text">
      <strong id="ach-popup-name"></strong>
      <span id="ach-popup-desc"></span>
    </div>
  </div>

  <!-- ===================== ECRAN STATISTIQUES ===================== -->
  <div id="screen-stats" class="screen hidden">
    <div class="gallery-header">
      <button class="btn btn-outline btn-small" id="btn-back-from-stats">Retour</button>
      <h2>Statistiques</h2>
    </div>
    <div class="stats-grid" id="stats-grid" aria-live="polite"></div>
  </div>

  <!-- ===================== ECRAN DE FIN ===================== -->
  <div id="screen-finish" class="screen hidden">
    <div class="finish-card">
      <h1> termine !</h1>
      <p class="finish-subtitle">Felicitations, <strong id="finish-team"></strong> !</p>

      <div class="finish-score-box">
        <div class="finish-ring-container">
          <svg class="finish-ring" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke-width="8" stroke="var(--sand-dark)" />
            <circle id="finish-ring-fill" cx="60" cy="60" r="52" fill="none" stroke-width="8" stroke="var(--gold)"
              stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73"
              transform="rotate(-90 60 60)" />
          </svg>
          <div class="finish-ring-text">
            <div class="score-value" id="finish-score" aria-live="polite"></div>
            <div class="score-label">Score final</div>
          </div>
        </div>
      </div>

      <div class="finish-time-box">
        <div class="score-label">Temps total</div>
        <div class="score-value" id="finish-time" style="font-size:1.4rem"></div>
      </div>

      <div class="finish-mosaic" id="finish-mosaic"></div>

      <div class="finish-achievements" id="finish-achievements"></div>

      <div class="finish-backup-reminder" id="finish-backup-reminder">
        <strong>Pensez a sauvegarder !</strong>
        <p>Exportez vos donnees avant de lancer un nouveau rally.</p>
        <button class="btn btn-outline btn-small" id="btn-backup-finish">Sauvegarder les donnees</button>
      </div>

      <div class="finish-actions">
        <button class="btn btn-outline btn-small" id="btn-back-map-2">Voir la carte</button>
        <button class="btn btn-secondary btn-small" id="btn-export">Exporter l'image</button>
        <button class="btn btn-secondary btn-small" id="btn-export-pdf">Exporter PDF</button>
        <button class="btn btn-secondary btn-small" id="btn-share">Partager</button>
        <button class="btn btn-primary" id="btn-new-rally">Nouveau Rally</button>
      </div>
    </div>
  </div>

  <!-- ===================== TUTORIEL / ONBOARDING ===================== -->
  <div id="onboarding-overlay" class="onboarding-overlay hidden" role="dialog" aria-modal="true" aria-label="Tutoriel">
    <div class="onboarding-card">
      <div class="onboarding-steps" id="onboarding-steps">
        <div class="onboarding-step" data-step="0">
          <span class="onboarding-icon">&#128247;</span>
          <h3>Bienvenue dans Rally Photo !</h3>
          <p>Partez a la decouverte d'un parcours photo a travers des lieux remarquables. A chaque etape, prenez une photo pour valider votre passage.</p>
        </div>
        <div class="onboarding-step hidden" data-step="1">
          <span class="onboarding-icon">&#128204;</span>
          <h3>Etapes progressives</h3>
          <p>Les etapes se debloquent une par une. Validez la precedente pour acceder a la suivante. En <strong>mode libre</strong>, tout est accessible d'emblee.</p>
        </div>
        <div class="onboarding-step hidden" data-step="2">
          <span class="onboarding-icon">&#11088;</span>
          <h3>Defis bonus</h3>
          <p>Chaque etape propose un defi bonus optionnel pour gagner des points supplementaires. Prenez une photo bonus apres avoir valide l'etape.</p>
        </div>
        <div class="onboarding-step hidden" data-step="3">
          <span class="onboarding-icon">&#128161;</span>
          <h3>Indices progressifs</h3>
          <p>Bloque ? Utilisez les indices pour vous aider, mais attention : chaque indice coute des points !</p>
        </div>
        <div class="onboarding-step hidden" data-step="4">
          <span class="onboarding-icon">&#127942;</span>
          <h3>Succes et classement</h3>
          <p>Debloquez des succes en jouant et comparez votre score avec d'autres equipes dans le classement. Bonne aventure !</p>
        </div>
      </div>
      <div class="onboarding-dots" id="onboarding-dots"></div>
      <div class="onboarding-actions">
        <button class="btn btn-outline btn-small" id="btn-onboarding-skip">Passer</button>
        <button class="btn btn-primary btn-small" id="btn-onboarding-next">Suivant</button>
      </div>
    </div>
  </div>

  <!-- ===================== DIALOGUE GESTION CACHE TUILES ===================== -->
  <div id="tile-cache-dialog" class="confirm-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="tile-cache-title">
    <div class="confirm-card">
      <h3 id="tile-cache-title">Carte hors-ligne</h3>
      <div class="tile-cache-info">
        <p id="tile-cache-stats">Chargement...</p>
      </div>
      <div class="confirm-actions">
        <button class="btn btn-outline btn-small" id="btn-tile-cache-close">Fermer</button>
        <button class="btn btn-outline btn-small btn-danger" id="btn-tile-cache-clear">Supprimer le cache</button>
        <button class="btn btn-primary btn-small" id="btn-tile-cache-refresh">Retelecharger</button>
      </div>
    </div>
  </div>

  <!-- ===================== BANDEAU MISE A JOUR ===================== -->
  <div id="sw-update-banner" class="sw-update-banner hidden" role="alert">
    <span>Mise a jour disponible !</span>
    <button class="btn btn-primary btn-small" id="btn-sw-reload">Recharger</button>
    <button class="sw-update-dismiss" id="btn-sw-dismiss" aria-label="Fermer">&times;</button>
  </div>

  <!-- ===================== BANDEAU HORS LIGNE ===================== -->
  <div id="offline-bar" class="offline-bar hidden" role="status" aria-live="polite">
    Vous etes hors ligne — l'app reste fonctionnelle
  </div>

  <!-- ===================== CONFIRMATION DIALOG ===================== -->
  <div id="confirm-dialog" class="confirm-overlay hidden" role="alertdialog" aria-modal="true"
    aria-labelledby="confirm-title" aria-describedby="confirm-message">
    <div class="confirm-card">
      <h3 id="confirm-title">Confirmation</h3>
      <p id="confirm-message">Etes-vous sur ?</p>
      <div class="confirm-actions">
        <button class="btn btn-outline btn-small" id="confirm-cancel">Annuler</button>
        <button class="btn btn-primary btn-small" id="confirm-ok">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- ===================== QUIZ DIALOG ===================== -->
  <div id="quiz-dialog" class="confirm-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="quiz-question">
    <div class="confirm-card quiz-card">
      <div class="quiz-header">
        <span class="quiz-difficulty-badge" id="quiz-difficulty"></span>
        <span class="quiz-points-badge" id="quiz-points-badge"></span>
      </div>
      <h3 id="quiz-question"></h3>
      <div class="quiz-choices" id="quiz-choices"></div>
      <div class="quiz-feedback hidden" id="quiz-feedback" aria-live="assertive"></div>
    </div>
  </div>

  <!-- ===================== ECRAN GESTION RALLYES PERSONNALISES ===================== -->
  <div id="screen-editor-list" class="screen hidden" role="main" aria-label="Rallyes personnalises">
    <div class="gallery-header">
      <button class="btn btn-outline btn-small" id="btn-editor-back">&#8592; Retour</button>
      <h2>Mes rallyes</h2>
    </div>
    <div class="editor-list-content">
      <div class="editor-list-actions">
        <button class="btn btn-primary" id="btn-create-rally">+ Creer un rally</button>
        <button class="btn btn-outline btn-small" id="btn-import-rally">Importer</button>
        <input type="file" id="import-rally-input" accept=".json" class="hidden" />
      </div>
      <div id="custom-rally-list" class="custom-rally-list"></div>
      <p class="editor-empty hidden" id="editor-empty-msg">
        Vous n'avez pas encore cree de rally. Commencez par en creer un !
      </p>
    </div>
  </div>

  <!-- ===================== EDITEUR DE RALLY ===================== -->
  <div id="screen-editor" class="screen hidden" role="main" aria-label="Editeur de rally">
    <div class="editor-header">
      <button class="btn btn-outline btn-small" id="btn-editor-close">&#8592; Fermer</button>
      <h2 id="editor-title">Nouveau rally</h2>
    </div>
    <div class="editor-stepper" id="editor-stepper">
      <div class="step-dot active" data-step="0"><span>1</span><small>Infos</small></div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="1"><span>2</span><small>Etapes</small></div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="2"><span>3</span><small>Carte</small></div>
      <div class="step-line"></div>
      <div class="step-dot" data-step="3"><span>4</span><small>Apercu</small></div>
    </div>

    <!-- Step 1: Metadata -->
    <div class="editor-step" id="editor-step-0">
      <div class="editor-form">
        <div class="input-group">
          <label for="ed-name">Nom du rally *</label>
          <input type="text" id="ed-name" placeholder="ex : Rally Photo Paris" maxlength="60" />
        </div>
        <div class="input-group">
          <label for="ed-shortname">Nom court *</label>
          <input type="text" id="ed-shortname" placeholder="ex : Paris" maxlength="20" />
        </div>
        <div class="input-group">
          <label for="ed-subtitle">Sous-titre</label>
          <input type="text" id="ed-subtitle" placeholder="ex : La ville lumiere en photos" maxlength="80" />
        </div>
        <div class="input-group">
          <label for="ed-description">Description</label>
          <textarea id="ed-description" rows="2" maxlength="200" placeholder="Description courte du rally..."></textarea>
        </div>
        <div class="input-group input-row">
          <div>
            <label for="ed-color-primary">Couleur principale</label>
            <input type="color" id="ed-color-primary" value="#1e3a5f" />
          </div>
          <div>
            <label for="ed-color-accent">Couleur accent</label>
            <input type="color" id="ed-color-accent" value="#d97706" />
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Checkpoints -->
    <div class="editor-step hidden" id="editor-step-1">
      <div class="editor-cp-list" id="editor-cp-list"></div>
      <button class="btn btn-outline btn-small" id="btn-add-checkpoint" style="margin-top:0.8rem">+ Ajouter une etape</button>
    </div>

    <!-- Step 3: Map Review -->
    <div class="editor-step hidden" id="editor-step-2">
      <p class="editor-map-hint">Glissez les marqueurs pour ajuster les positions. Cliquez sur la carte pour placer une etape.</p>
      <div id="editor-map" class="editor-map"></div>
    </div>

    <!-- Step 4: Preview -->
    <div class="editor-step hidden" id="editor-step-3">
      <div id="editor-preview" class="editor-preview"></div>
    </div>

    <!-- Navigation -->
    <div class="editor-nav">
      <button class="btn btn-outline btn-small hidden" id="btn-editor-prev">Precedent</button>
      <span class="editor-nav-spacer"></span>
      <button class="btn btn-primary btn-small" id="btn-editor-next">Suivant</button>
      <button class="btn btn-primary btn-small hidden" id="btn-editor-save">Enregistrer le rally</button>
    </div>
  </div>

  <!-- ===================== MODAL PARTAGE DE RALLY ===================== -->
  <div id="share-rally-dialog" class="confirm-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="share-rally-title">
    <div class="confirm-card share-card">
      <h3 id="share-rally-title">Partager ce rally</h3>
      <p id="share-rally-name" class="share-rally-name"></p>
      <p id="share-rally-info" class="share-rally-info"></p>

      <div class="share-qr-container" id="share-qr-container">
        <canvas id="share-qr-canvas"></canvas>
        <p class="share-qr-hint" id="share-qr-hint">Scannez ce QR code pour rejoindre le rally</p>
      </div>

      <div class="share-link-group">
        <input type="text" id="share-link-input" class="share-link-input" readonly />
        <button class="btn btn-outline btn-small" id="btn-copy-share-link" title="Copier le lien">Copier</button>
      </div>

      <div class="share-actions">
        <button class="btn btn-secondary btn-small" id="btn-download-qr">Telecharger le QR</button>
        <button class="btn btn-primary btn-small hidden" id="btn-native-share">Partager</button>
        <button class="btn btn-outline btn-small" id="btn-close-share">Fermer</button>
      </div>

      <p class="share-warning hidden" id="share-size-warning"></p>
    </div>
  </div>

  <!-- ===================== MODAL REJOINDRE UN RALLY ===================== -->
  <div id="join-rally-dialog" class="confirm-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="join-rally-title">
    <div class="confirm-card join-card">
      <h3 id="join-rally-title">Rejoindre un rally</h3>
      <div class="input-group">
        <label for="join-link-input">Collez le lien de partage</label>
        <input type="text" id="join-link-input" placeholder="https://...#/join/..." autocomplete="off" />
      </div>
      <div class="confirm-actions">
        <button class="btn btn-outline btn-small" id="btn-cancel-join">Annuler</button>
        <button class="btn btn-primary btn-small" id="btn-confirm-join-link">Rejoindre</button>
      </div>
    </div>
  </div>

  <!-- ===================== MODAL CONFIRMATION IMPORT RALLY ===================== -->
  <div id="join-confirm-dialog" class="confirm-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="join-confirm-title">
    <div class="confirm-card">
      <h3 id="join-confirm-title">Importer ce rally ?</h3>
      <div id="join-confirm-preview" class="join-preview"></div>
      <div class="confirm-actions">
        <button class="btn btn-outline btn-small" id="btn-cancel-join-confirm">Annuler</button>
        <button class="btn btn-primary btn-small" id="btn-accept-join">Importer et jouer</button>
      </div>
    </div>
  </div>

  <!-- ===================== SCRIPTS ===================== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/lzstring.min.js"></script>
  <script src="js/qrcode.min.js"></script>
  <script src="js/rallies.js"></script>
  <script src="rallies/normandie.js"></script>
  <script src="rallies/lyon.js"></script>
  <script src="js/custom-loader.js"></script>
  <script src="js/photostore.js"></script>
  <script src="js/game.js"></script>
  <script src="js/photos.js"></script>
  <script src="js/map.js"></script>
  <script src="js/editor.js"></script>
  <script src="js/app.js"></script>
  <script src="js/sw-register.js"></script>
</body>

</html>